<ui:component xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:p="http://primefaces.org/ui"
	xmlns:wex="http://java.sun.com/jsf/composite/wex-cc"	
   	xmlns:composite="http://java.sun.com/jsf/composite">
   	
	<composite:interface>
		<composite:attribute name="edition" default="false" />
	</composite:interface>
	
	<composite:implementation>
		<c:set var="expense" value="#{expenseEditionController.currentElement}" />
		
		<wex:dbableDetails dbable="#{expense}"/>

		<h:panelGrid id="expenseFieldsPanelId" columns="2" rendered="#{not empty expense}" style="width:100%" styleClass="js-expense">
			<h:outputText value=""/>
			<p:messages for="ValidationErrors" showDetail="true" showSummary="true" />
			
			<h:outputText value="type" styleClass="wex-field-label"/>
			<h:outputText value="#{expense.expenseType.name}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			<p:autoComplete id="expenseTypeId" value="#{expense.expenseType}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"
			 	dropdown="true" completeMethod="#{dropboxController.completeExpenseType}" converter="#{expenseTypeConverter}" 
             	var="theme" itemLabel="#{theme.name}" itemValue="#{theme}" forceSelection="true" >
             	<p:ajax event="itemSelect" update="payeeSelector" />
             </p:autoComplete>
 			
			<h:outputText value="payee" styleClass="wex-field-label"/>
			<p:outputPanel id="payeeSelector">
				<wex:payeeSelector payee="#{expense.payee}" payeeDisplayer="#{expense.expenseType.displayer}" edition="#{cc.attrs.edition}" handleSelect="#{expenseEditionController.handlePayeeChange}" update="@(.js-expense)" />
			</p:outputPanel>			
             	
			<h:outputText value="date" styleClass="wex-field-label"/>
			<h:outputText value="#{expense.date}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
				<f:converter converterId="localDateTimeCustomConverter" />
			</h:outputText>
			<h:panelGrid columns="3" rendered="#{cc.attrs.edition}" >
				<p:inputText id="expenseDateText" value="#{expense.date}">
				 	<f:converter converterId="localDateTimeCustomConverter"/> 
				 	<p:ajax listener="#{expenseEditionController.onDateChange}" update="expenseDateText expenseDateError expenseDatePicker @(.js-date-related)"  />
				</p:inputText>
				<p:datePicker id="expenseDatePicker" value="#{expense.date}" showIcon="true" showButtonBar="true" readonlyInput="true" showTime="true" styleClass="wex-datepicker" >
				 	<p:ajax event="dateSelect" listener="#{expenseEditionController.handleDateChange}" update="expenseDateText expenseDateError @(.js-date-related)"  />
				</p:datePicker>
				<h:panelGrid columns="2" id="expenseDateError">
					<p:message for="expenseDateText" display="icon" showDetail="true" />
					<p:message for="expenseDatePicker" display="icon" showDetail="true" />
				</h:panelGrid>
			</h:panelGrid>
				 
			<h:outputText value="amount" styleClass="wex-field-label"/>
			<h:panelGroup rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
				<h:outputFormat value="{0,number, ###0.00} #{expense.currencyCode}">
					<f:param value="#{expense.currencyAmount}" />
				</h:outputFormat>
				<h:outputText value=""/>
				<h:outputFormat value="{0,number, ###0.00} #{requestController.defaultCurrency.code}" rendered="#{expense.currencyCode!=requestController.defaultCurrency.code}">
					<f:param value="#{expense.accountingValue}" />
				</h:outputFormat>
			</h:panelGroup>
			<h:panelGroup rendered="#{cc.attrs.edition}" styleClass="wex-field-edit">
			    <p:inputNumber id="expenseCurrencyAmountId" value="#{expense.currencyAmount}" thousandSeparator="'">
			    	<p:ajax listener="#{expenseEditionController.onAmountChange}"  update="expenseFieldsPanelId @(.js-value-related)" />
			    </p:inputNumber>  
			    <p:selectOneMenu id="expenseCurrencyCodeId" value="#{expense.currencyCode}" >
			    	<p:ajax listener="#{expenseEditionController.onCurrencyChange}"  update="expenseFieldsPanelId @(.js-value-related)" />
                	<f:selectItems value="#{dropboxController.currencies}" />
                	<h:outputText value="#{expense.accountingValue}"/>
            	</p:selectOneMenu>
				<h:outputFormat value="{0,number, ###0.00} #{requestController.defaultCurrency.code}" rendered="#{not empty expense.accountingValue &amp;&amp; expense.currencyCode!=requestController.defaultCurrency.code}">
					<f:param value="#{expense.accountingValue}" />
				</h:outputFormat>
			</h:panelGroup>

			<h:panelGroup id="exchangeRateLabelId" rendered="#{expense.currencyCode!=requestController.defaultCurrency.code &amp;&amp; not empty expense.exchangeRate}">
				<h:outputText  value="exchange rate" styleClass="wex-field-label" />
			</h:panelGroup>
			<h:panelGroup id="exchangeRatePanelId" rendered="#{expense.currencyCode!=requestController.defaultCurrency.code &amp;&amp; not empty expense.exchangeRate}" >
				<h:panelGroup rendered="#{not cc.attrs.edition}">
					<div class="p-grid ui-fluid p-field ">
			        	<div class="p-col">
			        		<h:panelGroup styleClass="js-date-related">
								<h:outputText value="#{expense.exchangeRate.date}" rendered="#{not cc.attrs.edition}" >
									<f:convertDateTime type="localDate" pattern="dd/MM/yyyy" />
								</h:outputText>
			        		</h:panelGroup>
							<h:outputText value="#{expense.exchangeRate.institution.prefix}#{expense.exchangeRate.institution.name} #{expense.exchangeRate.institution.extra}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			        	</div>
			        	<div class="p-col">
							<h:outputFormat value="{0,number, 0.00000}" >
								<f:param value="#{expense.exchangeRate.rate}" />
							</h:outputFormat>							
							<h:outputFormat value="{0,number, 0.00#}%" rendered="#{not empty expense.exchangeRate.fee}" >
								<f:param value="x #{expense.exchangeRate.fee}" />
							</h:outputFormat>
							<h:outputFormat value="{0,number, 0.00} " rendered="#{not empty expense.exchangeRate.fixFee}" >
								<f:param value="+ #{expense.exchangeRate.fixFee}" />
							</h:outputFormat>
			        	</div>
		        	</div>
				</h:panelGroup>
				
				<h:panelGroup rendered="#{cc.attrs.edition}">
					<div class="p-grid ui-fluid p-field ">
			        	<div class="p-col-12 p-md-4">
				            <p:outputLabel for="exchangeRateDateId" value="date" />
							<p:datePicker id="exchangeRateDateId" value="#{expense.exchangeRate.date}" rendered="#{cc.attrs.edition}" pattern="dd/MM/yyyy" showIcon="true" showButtonBar="true" appendTo="@(body)"/>
			        	</div>
			        	
			        	<div class="p-col-12 p-md-8">
				            <p:outputLabel for="exchangeRateInstutionId" value="provider" />
							<p:autoComplete id="exchangeRateInstutionId" value="#{expense.exchangeRate.institution}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"
				 				dropdown="true" completeMethod="#{dropboxController.completePayee}" converter="#{payeeConverter}" 
		            			var="theme" itemLabel="#{theme.prefix}#{theme.name} #{theme.extra}" itemValue="#{theme}" forceSelection="true" />
		            		</div>
		
			            <div class="p-col-12 p-md-6">
				            <p:outputLabel for="xrateId" value="rate" />
							<p:inputNumber id="xrateId" value="#{expense.exchangeRate.rate}" thousandSeparator="'" decimalPlaces="8" rendered="#{cc.attrs.edition}" >
						    	<p:ajax listener="#{expenseEditionController.onAmountChange}" update="expenseFieldsPanelId @(.js-value-related)" />
						    </p:inputNumber>					    			
					    </div>
					    
			            <div class="p-col-12 p-md-3">
				            <p:outputLabel for="xfeeId" value="fee" />
							<p:inputNumber id="xfeeId" value="#{expense.exchangeRate.fee}" thousandSeparator="'" rendered="#{cc.attrs.edition}" symbol="%" symbolPosition="s" decimalPlaces="3" >
						    	<p:ajax listener="#{expenseEditionController.onAmountChange}" update="expenseFieldsPanelId @(.js-value-related)" />
						    </p:inputNumber>
					    </div>
					    
			            <div class="p-col-12 p-md-3">
				            <p:outputLabel for="xfixFeeId" value="fix fee" />
							<p:inputNumber id="xfixFeeId" value="#{expense.exchangeRate.fixFee}" thousandSeparator="'" rendered="#{cc.attrs.edition}" symbol=" #{expense.currencyCode}" symbolPosition="s" >
						    	<p:ajax listener="#{expenseEditionController.onAmountChange}" update="expenseFieldsPanelId @(.js-value-related)" />
						    </p:inputNumber>
					    </div>
				    </div>
				</h:panelGroup>
			</h:panelGroup>

			<h:outputText value="external reference" styleClass="wex-field-label"/>
			<h:outputText value="#{expense.externalReference}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			<p:inputText id="expenseExternalReferenceId" value="#{expense.externalReference}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"/>
			
			<h:outputText value="description" styleClass="wex-field-label"/>
			<h:outputText value="#{expense.description}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			<p:inputText id="expenseDescriptionId" value="#{expense.description}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"/>
		</h:panelGrid>

		<p/>
		<p:dataTable id="documentFilesTableId" rendered="#{not empty expense}" var="docFile" value="#{expense.documentFiles}"
				styleClass="js-documentFilesTable" resizableColumns="true" 
                selection="#{expenseEditionController.selectedDocumentFile}" 
                selectionMode="single"
                rowKey="#{docFile.uid}"
                disableContextMenuIfEmpty="false" 
                > 

			<!-- 
			<f:facet name="header">
				Documents
				<p:commandButton id="documentFilesTableToggler" type="button" style="float:left" icon="pi pi-align-justify" />
				<p:columnToggler datasource="documentFilesTableId" trigger="documentFilesTableToggler" />
			</f:facet>
			-->
			
			<f:facet name="footer"  >
				<p:outputPanel rendered="#{cc.attrs.edition}" style="display:flex">
					<p:commandButton style="font-size: small;margin:10px 0;" value="Add" update="documentFilesTableId" icon="pi pi-plus" action="#{expenseEditionController.addDocumentFile}"/>
					<p:outputPanel style="width:100%">
						<wex:documentFileSelector extra="#{expense}" edition="#{cc.attrs.edition}" />
					</p:outputPanel>
				</p:outputPanel>
			</f:facet>
			
			<ui:include src="/includes/dbableColumns.xhtml">
				<ui:param name="dba" value="#{docFile}" />
			</ui:include>	    
			
            <p:column headerText="Date" style="max-width:130px; width:130px">
            	<h:outputText value="#{docFile.documentDate}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
					<f:convertDateTime type="localDate" pattern="dd/MM/yyyy" />
				</h:outputText>
				<p:datePicker id="documentDateId" value="#{docFile.documentDate}" rendered="#{cc.attrs.edition}" styleClass="wex-small-datepicker"
					pattern="dd/MM/yyyy"
					showIcon="true"
					showButtonBar="true"
					appendTo="@(body)">
			 		<p:ajax event="dateSelect" listener="#{expenseEditionController.onDocumentFileDateChange(docFile)}" update="@(.js-docdate-related)"  />
			 	</p:datePicker>
    	   	</p:column>
            
            <p:column headerText="Filename (#{expense.documentCount})" style="width:100%">
           		<h:outputText value="#{docFile.fileName}" rendered="#{not cc.attrs.edition}" />
          		<p:inputText id="fileNameId" value="#{docFile.fileName}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit js-docdate-related"/>
       		</p:column>
       		
       		<p:column headerText="View" style="max-width:50px;width:50px" >
       			<p:button href="#{documentFileSelector.getDocumentFileUrlFor(docFile)}" icon="pi pi-search" target="_blank" styleClass="js-docdate-related"/>
       		</p:column>
		</p:dataTable>        		
       
        <p:contextMenu for="documentFilesTableId" rendered="#{not empty expense}">
        	<p:menuitem value="Delete" update="documentFilesTableId" icon="pi pi-trash" action="#{expenseEditionController.deleteDocumentFile}"/>
    	</p:contextMenu>
		
		<p/>		
		<p:dataTable id="transactions" rendered="#{not empty expense}" var="tentry" value="#{expense.transactions}" 
				styleClass="js-transactionEntryTable" resizableColumns="true" 
                selection="#{expenseEditionController.selectedTransactionEntry}" 
                selectionMode="single"				
				rowKey="#{tentry.uid}"
				disableContextMenuIfEmpty="false" 				
				style="width: auto;">
			
			<ui:include src="/includes/dbableColumns.xhtml">
				<ui:param name="dba" value="#{tentry}" />
			</ui:include>
			
            <p:column headerText="Date" styleClass="wex-cell-centered" style="max-width:130px; width:130px" >
            	<h:outputText value="#{tentry.accountingDate}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
					<f:convertDateTime type="localDate" pattern="dd/MM/yyyy" />
				</h:outputText>
				<p:datePicker id="transcationEntryId" value="#{tentry.accountingDate}" rendered="#{cc.attrs.edition}" 
					pattern="dd/MM/yyyy"
					showIcon="true"
					showButtonBar="true"
					appendTo="@(body)"
					styleClass="wex-small-datepicker js-date-related"
			 	/>
       		</p:column>
       					
			<p:column headerText="Year" styleClass="wex-cell-centered" style="max-width:70px; width:70px">
				<h:outputText value="#{tentry.accountingYear}" rendered="#{not cc.attrs.edition}" />
				<p:spinner id="accountingYearId" value="#{tentry.accountingYear}" rendered="#{cc.attrs.edition}" styleClass="js-date-related wex-input-70" thousandSeparator=""/>
			</p:column>

            <p:column headerText="Consolidated" styleClass="wex-cell-centered" style="max-width:120px; width:120px" >
            	<h:outputText value="#{tentry.consolidation.date}" styleClass="wex-field-value">
					<f:convertDateTime type="localDate" pattern="MMM yyyy" />
				</h:outputText>
			</p:column>
			
			<p:column headerText="Accounts" style="width:100%" >
				<h:panelGroup rendered="#{not cc.attrs.edition}">
					<ui:repeat var="t" value="#{tentry.tags}">#{t.name}</ui:repeat>
				</h:panelGroup>
				<h:panelGroup rendered="#{cc.attrs.edition}">
					<p:autoComplete multiple="true" value="#{tentry.tagsList}" completeMethod="#{dropboxController.completeTag}" unique="true" var="theme"
						itemLabel="#{theme.name}" itemValue="#{theme}" converter="#{tagConverter}" forceSelection="true" styleClass="wex-field-edit wex-tags">
						<p:column>
							<h:outputText value="#{theme.name}" styleClass="wex-tags-#{theme.type}" />
						</p:column>
					</p:autoComplete>
				</h:panelGroup>
			</p:column>

			<p:column headerText="Factor" style="max-width:120px; width:120px">
				<h:outputText value="#{tentry.factor}" rendered="#{not cc.attrs.edition}" />
				<p:selectOneButton value="#{tentry.factor}" rendered="#{cc.attrs.edition}" converter="#{transactionFactorConverter}">
					<f:selectItems value="#{dropboxController.transactionFactors}" />
					<p:ajax listener="#{expenseEditionController.onTransactionAmountChange(tentry)}" update="@(.js-transaction-value-related)" />
				</p:selectOneButton>
			</p:column>

			<p:column headerText="Amount" styleClass="wex-cell-righted" style="max-width:160px; width:160px">
				<h:outputText value="#{tentry.currencyAmount} #{expense.currencyCode}" rendered="#{not cc.attrs.edition}" />
				<p:inputNumber value="#{tentry.currencyAmount}" rendered="#{cc.attrs.edition}" symbol=" #{expense.currencyCode}" symbolPosition="s" thousandSeparator="'" styleClass="wex-input-right wex-input-150 js-value-related" >
					<p:ajax listener="#{expenseEditionController.onTransactionAmountChange(tentry)}" update="@(.js-transaction-value-related)" />
				</p:inputNumber>
				<f:facet name="footer">
					<p:outputPanel styleClass="js-value-related js-transaction-value-related">
						<h:outputText value="#{expenseEditionController.transactionsSums.currencyAmountSums.sumIn} #{expense.currencyCode}" rendered="#{expenseEditionController.transactionsSums.currencyAmountSums.valid}" />
						<h:outputText value="#{expenseEditionController.transactionsSums.currencyAmountSums.delta} #{expense.currencyCode}" rendered="#{not expenseEditionController.transactionsSums.currencyAmountSums.valid}" style="color: #b94a48;"/>
					</p:outputPanel>
				</f:facet>
			</p:column>

			<p:column headerText="Value" styleClass="wex-cell-righted" style="max-width:120px; width:120px">
				<p:outputPanel styleClass="js-value-related js-transaction-value-related">
					<h:outputFormat value="{0,number, 0.00}" >
						<f:param value="#{tentry.accountingValue}" />
					</h:outputFormat>
				</p:outputPanel>
				<f:facet name="footer">
					<p:outputPanel styleClass="js-value-related js-transaction-value-related">
						<h:outputText value="#{expenseEditionController.transactionsSums.accountingValueSums.sumIn}" rendered="#{expenseEditionController.transactionsSums.accountingValueSums.valid}" />
						<h:outputText value="#{expenseEditionController.transactionsSums.accountingValueSums.delta}" rendered="#{not expenseEditionController.transactionsSums.accountingValueSums.valid}" style="color: #b94a48;"/>
					</p:outputPanel>
				</f:facet>				
			</p:column>
		</p:dataTable>
		
		<p:contextMenu for="transactions" rendered="#{not empty expense}">
        	<p:menuitem value="Add" update="transactions" icon="pi pi-plus" action="#{expenseEditionController.newTransactionEntry}"/>
        	<p:menuitem value="Delete" update="transactions" icon="pi pi-trash" action="#{expenseEditionController.deleteTransactionEntry}"/>
    	</p:contextMenu>

   	</composite:implementation>
</ui:component>