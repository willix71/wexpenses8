<ui:component xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:p="http://primefaces.org/ui"
	xmlns:wex="http://java.sun.com/jsf/composite/wex-cc"	
   	xmlns:composite="http://java.sun.com/jsf/composite">
   	
	<composite:interface>
		<composite:attribute name="expense" type="w.expenses8.data.domain.model.Expense" required="true" />
		<composite:attribute name="edition" default="false" />
	</composite:interface>
	
	<composite:implementation>
		<c:set var="controller" value="#{expenseController}" />
		
		<wex:dbableDetails dbable="#{cc.attrs.expense}"/>
		
		<h:panelGrid id="expenseFieldsPanelId" columns="2" rendered="#{not empty cc.attrs.expense}" style="width:100%">
			<h:outputText value="type" styleClass="wex-field-label"/>
			<h:outputText value="#{cc.attrs.expense.expenseType.name}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			<p:autoComplete id="expenseTypeId" value="#{cc.attrs.expense.expenseType}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"
			 	dropdown="true" completeMethod="#{dropboxController.completeExpenseType}" converter="#{expenseTypeConverter}" 
             	var="theme" itemLabel="#{theme.name}" itemValue="#{theme}" forceSelection="true" />
             	
			<h:outputText value="payee" styleClass="wex-field-label"/>
			<h:outputText value="#{cc.attrs.expense.payee.prefix}#{cc.attrs.expense.payee.name} #{cc.attrs.expense.payee.extra}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			<p:autoComplete id="expensePayeeId" value="#{cc.attrs.expense.payee}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"
			 	dropdown="true" completeMethod="#{dropboxController.completePayee}" converter="#{payeeConverter}" 
             	var="theme" itemLabel="#{theme.prefix}#{theme.name} #{theme.extra}" itemValue="#{theme}" forceSelection="true" />
			
			<h:outputText value="date" styleClass="wex-field-label"/>
			<h:outputText value="#{cc.attrs.expense.date}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
				<f:convertDateTime type="localDateTime" pattern="dd/MM/yyyy HH:mm" />
			</h:outputText>
			<p:datePicker id="expenseDateId" value="#{cc.attrs.expense.date}" rendered="#{cc.attrs.edition}"
				pattern="dd/MM/yyyy"
				showIcon="true"
				showButtonBar="true"
				appendTo="@(body)"
				showTime="true"
				/>
				 
			<h:outputText value="amount" styleClass="wex-field-label"/>
			<h:panelGroup rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
				<h:outputFormat value="{0,number, ###0.00} #{cc.attrs.expense.currencyCode}">
					<f:param value="#{cc.attrs.expense.currencyAmount}" />
				</h:outputFormat>
				<h:outputText value=""/>
				<h:outputFormat value="{0,number, ###0.00} #{requestController.defaultCurrency.code}" rendered="#{cc.attrs.expense.currencyCode!=requestController.defaultCurrency.code}">
					<f:param value="#{cc.attrs.expense.accountingValue}" />
				</h:outputFormat>
			</h:panelGroup>
			<h:panelGroup rendered="#{cc.attrs.edition}" styleClass="wex-field-edit">
			    <p:inputNumber id="expenseCurrencyAmountId" value="#{cc.attrs.expense.currencyAmount}" thousandSeparator="'">
			    	<p:ajax  listener="#{controller.assistant.onAmountChange}"  update="expenseFieldsPanelId transactionEntriesTableId" />
			    </p:inputNumber>  
			    <p:selectOneMenu id="expenseCurrencyCodeId" value="#{cc.attrs.expense.currencyCode}" >
			    	<p:ajax  listener="#{controller.assistant.onCurrencyChange}"  update="expenseFieldsPanelId transactionEntriesTableId" />
                	<f:selectItems value="#{dropboxController.currencies}" />
                	<h:outputText value="#{cc.attrs.expense.accountingValue}"/>
            	</p:selectOneMenu>
				<h:outputFormat value="{0,number, ###0.00} #{requestController.defaultCurrency.code}" rendered="#{cc.attrs.expense.currencyCode!=requestController.defaultCurrency.code}">
					<f:param value="#{cc.attrs.expense.accountingValue}" />
				</h:outputFormat>
			</h:panelGroup>

			<h:panelGroup id="exchangeRateLabelId" rendered="#{cc.attrs.expense.currencyCode!=requestController.defaultCurrency.code}">
				<h:outputText  value="exchange rate" styleClass="wex-field-label" />
			</h:panelGroup>
			<h:panelGroup id="exchangeRatePanelId" rendered="#{cc.attrs.expense.currencyCode!=requestController.defaultCurrency.code}">
				<h:panelGroup rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
					echange rate view
				</h:panelGroup>
				<h:panelGroup rendered="#{cc.attrs.edition}" styleClass="wex-field-value">
					rate #{cc.attrs.expense.exchangeRate.rate}
				</h:panelGroup>
			</h:panelGroup>

			<h:outputText value="external reference" styleClass="wex-field-label"/>
			<h:outputText value="#{cc.attrs.expense.externalReference}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			<p:inputText id="expenseExternalReferenceId" value="#{cc.attrs.expense.externalReference}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"/>
			
			<h:outputText value="description" styleClass="wex-field-label"/>
			<h:outputText value="#{cc.attrs.expense.description}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value"/>
			<p:inputText id="expenseDescriptionId" value="#{cc.attrs.expense.description}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"/>
		</h:panelGrid>

		<p/>
		<p:dataTable id="documentFilesTableId"  var="docFile" value="#{cc.attrs.expense.documentFiles}"
				styleClass="js-documentFilesTable" resizableColumns="true" 
                selection="#{controller.selectedDocumentFile}" 
                selectionMode="single"
                rowKey="#{docFile.uid}"
                disableContextMenuIfEmpty="false" 
                > 

			<!-- 
			<f:facet name="header">
				Documents
				<p:commandButton id="documentFilesTableToggler" type="button" style="float:left" icon="pi pi-align-justify" />
				<p:columnToggler datasource="documentFilesTableId" trigger="documentFilesTableToggler" />
			</f:facet>
			-->
			
			<ui:include src="/includes/dbableColumns.xhtml">
				<ui:param name="dba" value="#{docFile}" />
			</ui:include>	    
			
            <p:column headerText="Date" style="max-width:70px; width:70px">
            	<h:outputText value="#{docFile.documentDate}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
					<f:convertDateTime type="localDate" pattern="dd/MM/yyyy" />
				</h:outputText>
				<p:datePicker id="documentDateId" value="#{docFile.documentDate}" rendered="#{cc.attrs.edition}"
					pattern="dd/MM/yyyy"
					showIcon="true"
					showButtonBar="true"
					appendTo="@(body)"
			 	/>
       		</p:column>
            
            <p:column headerText="Filename (#{cc.attrs.expense.documentCount})" style="max-width:120px; width:120px">
           		<h:outputText value="#{docFile.fileName}" rendered="#{not cc.attrs.edition}" />
          		<p:inputText id="fileNameId" value="#{docFile.fileName}" rendered="#{cc.attrs.edition}" styleClass="wex-field-edit"/>
       		</p:column>
       		
       		<p:column headerText="View" style="max-width:10px; width:10px" width="5" >
       			<p:button href="http://www.stackoverflow.com" icon="pi pi-search" target="_blank"/>
       		</p:column>
		</p:dataTable>        		
       
        <p:contextMenu for="documentFilesTableId">
        	<p:menuitem value="Add" update="documentFilesTableId" icon="pi pi-plus" action="#{controller.newDocumentFile}"/>
        	<p:menuitem value="Delete" update="documentFilesTableId" icon="pi pi-trash" action="#{controller.deleteDocumentFile}"/>
    	</p:contextMenu>
		
		<p/>		
		<p:dataTable id="transactionEntriesTableId" var="tentry" value="#{cc.attrs.expense.transactions}" 
				styleClass="js-transactionEntryTable" resizableColumns="true" 
                selection="#{controller.selectedTransactionEntry}" 
                selectionMode="single"				
				rowKey="#{tentry.uid}"
				disableContextMenuIfEmpty="false" 				
				expandedRow="true" 
				style="width: auto;">

			<!-- 
			<f:facet name="header">
				Transactions
				<p:commandButton id="transactionEntriesTableToggler" type="button" style="float:left" icon="pi pi-align-justify" />
				<p:columnToggler datasource="transactionEntriesTableId" trigger="transactionEntriesTableToggler" />
			</f:facet>
			-->
			
			<ui:include src="/includes/dbableColumns.xhtml">
				<ui:param name="dba" value="#{tentry}" />
			</ui:include>
			
            <p:column headerText="Date" style="max-width:70px; width:70px">
            	<h:outputText value="#{tentry.accountingDate}" rendered="#{not cc.attrs.edition}" styleClass="wex-field-value">
					<f:convertDateTime type="localDate" pattern="dd/MM/yyyy" />
				</h:outputText>
				<p:datePicker id="transcationEntryId" value="#{tentry.accountingDate}" rendered="#{cc.attrs.edition}"
					pattern="dd/MM/yyyy"
					showIcon="true"
					showButtonBar="true"
					appendTo="@(body)"
			 	/>
       		</p:column>
       					
			<p:column headerText="Year" style="max-width:70px; width:70px">
				<h:outputText value="#{tentry.accountingYear}" rendered="#{not cc.attrs.edition}" />
				<p:spinner id="accountingYearId" value="#{tentry.accountingYear}" rendered="#{cc.attrs.edition}" styleClass="wex-input-70" thousandSeparator=""/>
			</p:column>

			<p:column headerText="Factor" style="max-width:120px; width:120px">
				<h:outputText value="#{tentry.factor}" rendered="#{not cc.attrs.edition}" />
				<p:selectOneButton value="#{tentry.factor}" rendered="#{cc.attrs.edition}" converter="#{transactionFactorConverter}">
					<f:selectItems value="#{dropboxController.transactionFactors}" />
				</p:selectOneButton>
			</p:column>

			<p:column headerText="System" styleClass="wex-cell-centered" style="max-width:50px; width:50px">
				<h:panelGroup rendered="#{tentry.systemEntry and not cc.attrs.edition}">
					<i class="pi pi-check"></i>
				</h:panelGroup>
				<p:selectBooleanCheckbox value="#{tentry.systemEntry}" rendered="#{cc.attrs.edition}" />
			</p:column>

			<p:column headerText="Amount" styleClass="wex-cell-righted" style="max-width:160px; width:160px">
				<h:outputText value="#{tentry.currencyAmount} #{cc.attrs.expense.currencyCode}" rendered="#{not cc.attrs.edition}" />
				<p:inputNumber value="#{tentry.currencyAmount}" rendered="#{cc.attrs.edition}" symbol=" #{cc.attrs.expense.currencyCode}" symbolPosition="s"
					thousandSeparator="'" styleClass="wex-input-right wex-input-150" />
			</p:column>

			<p:column headerText="Value" styleClass="wex-cell-righted" style="max-width:120px; width:120px">
				<h:outputText value="#{tentry.accountingValue}" />
			</p:column>

			<p:rowExpansion>
				<h:panelGroup rendered="#{not cc.attrs.edition}">
					<ui:repeat var="t" value="#{tentry.tags}">#{t.name}</ui:repeat>
				</h:panelGroup>
				<h:panelGroup rendered="#{cc.attrs.edition}">
					<p:autoComplete id="tagsId" multiple="true" value="#{tentry.tagsList}" completeMethod="#{dropboxController.completeTag}" unique="true" var="theme"
						itemLabel="#{theme.name}" itemValue="#{theme}" converter="#{tagConverter}" forceSelection="true" styleClass="wex-field-edit wex-tags">
						<p:column>
							<h:outputText value="#{theme.name}" styleClass="wex-tags-#{theme.type}" />
						</p:column>
					</p:autoComplete>
				</h:panelGroup>
			</p:rowExpansion>
		</p:dataTable>
		
		<p:contextMenu for="transactionEntriesTableId">
        	<p:menuitem value="Add" update="transactionEntriesTableId" icon="pi pi-plus" action="#{controller.newTransactionEntry}"/>
        	<p:menuitem value="Delete" update="transactionEntriesTableId" icon="pi pi-trash" action="#{controller.deleteTransactionEntry}"/>
    	</p:contextMenu>
   	</composite:implementation>
</ui:component>